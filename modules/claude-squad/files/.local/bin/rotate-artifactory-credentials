#!/usr/bin/env bash
set -euo pipefail

# ─────────────────────────────────────────────────────────
# Two Artifactory instances, three consumers
# ─────────────────────────────────────────────────────────
#
#   artylab.expedia.biz          → npm (.npmrc) + Gradle (gradle.properties)
#   artifactory.expedia.biz      → Swift Package Registry (sources scope)
#
# These are SEPARATE instances with separate identity systems.
# artylab accepts username/password → derives npm _auth + Gradle props.
# artifactory requires a UI-generated API token (SSO-backed).
# The token is cached in macOS keychain so you only enter it once.

ARTYLAB="https://artylab.expedia.biz"
ARTYLAB_NPM_HOST="//artylab.expedia.biz/api/npm/eg-npm-internal-local/"
EGDS_NPM_REGISTRY="${ARTYLAB}/api/npm/eg-npm-internal-local/"
NPMRC="$HOME/.npmrc"
GRADLE_PROPS="$HOME/.gradle/gradle.properties"

ARTIFACTORY="https://artifactory.expedia.biz"
SPM_REGISTRY="${ARTIFACTORY}/artifactory/api/swift/eg-internal-swift"
KEYCHAIN_SERVICE="rotate-artifactory-credentials"
KEYCHAIN_SPM_ACCOUNT="spm-token"

# ─────────────────────────────────────────────────────────
# Helpers
# ─────────────────────────────────────────────────────────
clean_leading_blanks() {
  python3 -c "
import sys
lines = open(sys.argv[1]).readlines()
start = next((i for i,l in enumerate(lines) if l.strip()), 0)
open(sys.argv[1], 'w').writelines(lines[start:])
" "$1"
}

update_file() {
  # Usage: update_file <file> <exclude_pattern> <content>
  local file="$1" pattern="$2" content="$3"
  python3 -c "
import re, os, sys
path = sys.argv[1]
pattern = sys.argv[2]
content = sys.argv[3]
try:
    with open(path, 'r') as f:
        lines = [l for l in f.readlines() if not re.search(pattern, l)]
except FileNotFoundError:
    lines = []
text = ''.join(lines).rstrip('\n') + '\n' + content + '\n'
os.makedirs(os.path.dirname(path) or '.', exist_ok=True)
with open(path, 'w') as f:
    f.write(text.lstrip('\n'))
" "$file" "$pattern" "$content"
}

keychain_get() {
  security find-generic-password -s "$KEYCHAIN_SERVICE" -a "$1" -w 2>/dev/null || true
}

keychain_set() {
  security delete-generic-password -s "$KEYCHAIN_SERVICE" -a "$1" 2>/dev/null || true
  security add-generic-password -s "$KEYCHAIN_SERVICE" -a "$1" -w "$2"
}

echo "=== Artifactory credential setup ==="
echo ""
echo "Two instances:"
echo "  1. artylab.expedia.biz   → npm + Gradle (Android)"
echo "  2. artifactory.expedia.biz → Swift SPM (iOS)"
echo ""

# ─────────────────────────────────────────────────────────
# 1. artylab.expedia.biz (npm + Gradle)
# ─────────────────────────────────────────────────────────
echo "--- artylab.expedia.biz ---"

DEFAULT_USER="$(whoami)"
read -rp "EG username [${DEFAULT_USER}]: " ARTYLAB_USER
ARTYLAB_USER="${ARTYLAB_USER:-$DEFAULT_USER}"
read -rsp "artylab password: " ARTYLAB_PASS
echo ""

echo "Validating..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -u "${ARTYLAB_USER}:${ARTYLAB_PASS}" "${ARTYLAB}/api/system/ping")
if [[ "$HTTP_CODE" != "200" ]]; then
  echo "Auth failed (HTTP ${HTTP_CODE})."
  exit 1
fi
echo "Valid."

# npm
echo "  npm → ~/.npmrc"
NPMRC_AUTH=$(curl -s -u "${ARTYLAB_USER}:${ARTYLAB_PASS}" "${ARTYLAB}/api/npm/auth")
NPM_AUTH_TOKEN=$(echo "$NPMRC_AUTH" | grep '_auth' | sed 's/.*= *//' | tr -d '"' | tr -d ' ')

if [[ -n "$NPM_AUTH_TOKEN" ]]; then
  update_file "$NPMRC" "^@egds:registry=|artylab\\.expedia\\.biz" "
# @egds Artifactory registry (managed by rotate-artifactory-credentials)
@egds:registry=${EGDS_NPM_REGISTRY}
${ARTYLAB_NPM_HOST}:_auth=${NPM_AUTH_TOKEN}"
  echo "    done."
else
  echo "    failed to fetch npm auth. Skipped."
fi

# Gradle
echo "  Gradle → ~/.gradle/gradle.properties"
update_file "$GRADLE_PROPS" "^ARTIFACTORY_|^# Artifactory credentials" "
# Artifactory credentials (managed by rotate-artifactory-credentials)
ARTIFACTORY_USER=${ARTYLAB_USER}
ARTIFACTORY_PASS=${ARTYLAB_PASS}
ARTIFACTORY_USERNAME=${ARTYLAB_USER}
ARTIFACTORY_PASSWORD=${ARTYLAB_PASS}"
echo "    done."

# ─────────────────────────────────────────────────────────
# 2. artifactory.expedia.biz (Swift SPM)
# ─────────────────────────────────────────────────────────
echo ""
echo "--- artifactory.expedia.biz (Swift SPM) ---"

if ! command -v swift >/dev/null 2>&1; then
  echo "  swift not found. Skipped."
else
  SPM_TOKEN=""

  # Try keychain first
  CACHED=$(keychain_get "$KEYCHAIN_SPM_ACCOUNT")
  if [[ -n "$CACHED" ]]; then
    echo "  Found cached token in keychain."
    SPM_TOKEN="$CACHED"
  fi

  # If no cached token, prompt once
  if [[ -z "$SPM_TOKEN" ]]; then
    echo ""
    echo "  No cached token found. A one-time setup is needed."
    echo ""
    echo "  Get your token from: https://artifactory.expedia.biz/"
    echo "    → Log in → Profile → Edit Profile → Generate API Key"
    echo ""
    echo "  (This token will be cached in your macOS keychain."
    echo "   Future runs will use it automatically.)"
    echo ""
    read -rsp "  Paste your artifactory.expedia.biz API token: " SPM_TOKEN
    echo ""

    if [[ -z "$SPM_TOKEN" ]]; then
      echo "  No token provided. Skipped."
    fi
  fi

  if [[ -n "$SPM_TOKEN" ]]; then
    # Write .netrc directly (swift package-registry login validates against
    # the server which may reject tokens that actually work for package resolution)
    export _NETRC_USER="$ARTYLAB_USER"
    export _NETRC_PASS="$SPM_TOKEN"
    python3 -c '
import re, os

user = os.environ["_NETRC_USER"]
token = os.environ["_NETRC_PASS"]
path = os.path.expanduser("~/.netrc")

try:
    content = open(path).read()
except FileNotFoundError:
    content = ""

# Remove existing artifactory block
content = re.sub(
    r"machine artifactory\.expedia\.biz\nlogin [^\n]*\npassword[^\n]*\n?",
    "", content
)
content = content.rstrip("\n") + (
    f"\n\nmachine artifactory.expedia.biz\n"
    f"login {user}\n"
    f"password {token}\n"
)
with open(path, "w") as f:
    f.write(content.lstrip("\n"))
os.chmod(path, 0o600)
'
    unset _NETRC_USER _NETRC_PASS

    # Configure registry URLs
    swift package-registry set --global "${SPM_REGISTRY}" 2>/dev/null || true
    swift package-registry set --global --scope sources "${SPM_REGISTRY}" 2>/dev/null || true

    # Cache in keychain
    keychain_set "$KEYCHAIN_SPM_ACCOUNT" "$SPM_TOKEN"

    echo "  Swift package registry configured."
    echo "  Token cached in keychain (future runs skip this prompt)."
  fi
fi

# ─────────────────────────────────────────────────────────
# Summary
# ─────────────────────────────────────────────────────────
echo ""
echo "=== Done ==="
echo ""
echo "  npm:    ~/.npmrc → artylab.expedia.biz"
echo "  Gradle: ~/.gradle/gradle.properties → artylab.expedia.biz"
if [[ -n "${SPM_TOKEN:-}" ]]; then
  echo "  Swift:  ~/.netrc + registries.json → artifactory.expedia.biz (cached)"
else
  echo "  Swift:  SKIPPED"
fi
echo ""
echo "Test:"
echo "  npm:     pnpm install (in @egds project)"
echo "  Android: ./gradlew :components:core:assembleDebug"
echo "  iOS:     swift package resolve"
