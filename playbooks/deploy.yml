---
# Main deployment playbook for dotfiles
- name: Deploy dotfiles using ansible-role-dotmodules
  hosts: localhost
  vars_files:
    - profiles.yml
  vars:
    # Configure MAS path for x86_64 Macs
    mas_path: "/usr/local/bin/mas"

  pre_tasks:
    - name: Verify minimum Ansible version
      ansible.builtin.assert:
        that:
          - ansible_version.full is version('2.17', '>=')
        fail_msg: "This playbook requires Ansible 2.17+. Found {{ ansible_version.full }}."

    - name: Resolve profile from hostname
      ansible.builtin.set_fact:
        detected_profile: "{{ hostname_to_profile[ansible_facts.hostname] | default('unknown') }}"

    - name: Compute final module list
      ansible.builtin.set_fact:
        final_modules: >-
          {{
            (base_modules + (profiles[detected_profile].include | default([])))
            | difference(profiles[detected_profile].exclude | default([]))
            | unique | sort
          }}
      when: detected_profile != 'unknown'

    - name: Use base modules for unknown hostname
      ansible.builtin.set_fact:
        final_modules: "{{ base_modules | unique | sort }}"
      when: detected_profile == 'unknown'

    - name: Show deployment plan
      ansible.builtin.debug:
        msg: "Profile: {{ detected_profile }} | Modules ({{ final_modules | length }}): {{ final_modules | join(', ') }}"

  roles:
    - role: ansible-role-dotmodules
      vars:
        dotmodules_repo: "file://{{ playbook_dir }}/../modules"
        dotmodules_dest: "{{ ansible_facts.env.HOME }}/.dotmodules"
        dotmodules_install: "{{ final_modules }}"
        mas_path: "/usr/local/bin/mas"
        # Skip geerlingguy.mac.mas role (uses become:true blocked by eIT).
        # MAS apps are installed in post_tasks without privilege escalation.
        dotmodules_skip_mas_role: true
        # Additional workarounds for geerlingguy.mac collection
        homebrew_install_path: "/opt/homebrew"
        homebrew_user: "{{ ansible_user_id }}"
        homebrew_group: "admin"
        homebrew_check_for_updates: false
        homebrew_upgrade_all_packages: false
        homebrew_clear_cache: false

  # Install MAS apps directly without become to avoid eIT sudo block.
  # The dotmodules role aggregates mas_installed_apps from module configs
  # and promotes it as a host fact, but we skip the geerlingguy.mac.mas
  # role (dotmodules_skip_mas_role: true) and install here instead.
  post_tasks:
    - name: Install Mac App Store apps (without become)
      community.general.mas:
        id: "{{ item }}"
        state: present
      environment:
        PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts.env.PATH }}"
      loop: "{{ mas_installed_apps | default([]) }}"
