---
# Main deployment playbook for dotfiles
- name: Deploy dotfiles using ansible-role-dotmodules
  hosts: localhost
  vars:
    dotmodules:
      repo: "file://{{ playbook_dir }}/../modules"
      dest: "{{ ansible_env.HOME }}/.dotmodules"
      install:
        - 1password
        - alfred
        - bartender
        - bin
        - chatgpt
        - chrome
        - claude
        - cursor
        - database
        - docker
        - dropbox
        - editor
        - finances
        - firefox
        - flux
        - git
        - go
        - grammarly
        - handbrake
        - iterm
        - karabiner
        - licecap
        - macos
        - media
        - ngrok
        - node
        - obsidian
        - productivity
        - rust
        - security
        - sequel-ace
        - speckit
        - spotify
        - tmux
        - vscode
        - zsh
    # Configure MAS path for x86_64 Macs
    mas_path: "/usr/local/bin/mas"
  roles:
    - role: ansible-role-dotmodules
      vars:
        mas_path: "/usr/local/bin/mas"
        # Skip geerlingguy.mac.mas role (uses become:true blocked by eIT).
        # MAS apps are installed in post_tasks without privilege escalation.
        dotmodules_skip_mas_role: true
        # Additional workarounds for geerlingguy.mac collection
        homebrew_install_path: "/opt/homebrew"
        homebrew_user: "{{ ansible_user_id }}"
        homebrew_group: "admin"
        homebrew_check_for_updates: false
        homebrew_upgrade_all_packages: false
        homebrew_clear_cache: false

  # Install MAS apps directly without become to avoid eIT sudo block.
  # The dotmodules role aggregates mas_installed_apps from module configs
  # and promotes it as a host fact, but we skip the geerlingguy.mac.mas
  # role (dotmodules_skip_mas_role: true) and install here instead.
  post_tasks:
    - name: Install Mac App Store apps (without become)
      community.general.mas:
        id: "{{ item }}"
        state: present
      environment:
        PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts.env.PATH }}"
      loop: "{{ mas_installed_apps | default([]) }}"
