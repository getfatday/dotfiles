---
phase: 07-validation-deploy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - playbooks/deploy.yml
autonomous: false

must_haves:
  truths:
    - "All modules in modules/ are listed in playbooks/deploy.yml install list"
    - "No secrets exist in any committed or staged files"
    - "No corporate artifacts exist in any committed or staged files"
    - "ansible-playbook --check passes cleanly"
    - "ansible-playbook real run succeeds on Mac Mini"
  artifacts:
    - path: "playbooks/deploy.yml"
      provides: "Complete module install list"
      contains: "all 36 active modules"
  key_links: []
---

<objective>
Validate the entire dotfiles repo is safe, correct, and deployable — then deploy to this Mac Mini.

Purpose: Final phase — prove everything works, then apply it for real.
Output: A fully deployed Mac Mini with all modules applied.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@playbooks/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing modules to deploy.yml</name>
  <files>
    playbooks/deploy.yml
  </files>
  <action>
Add all 17 missing modules to the `dotmodules.install` list in `playbooks/deploy.yml`.

Missing modules to add (alphabetical):
- bartender
- bin
- database
- dropbox
- firefox
- flux
- go
- karabiner
- licecap
- media
- ngrok
- rust
- security
- sequel-ace
- spotify
- tmux
- vscode

Maintain alphabetical order in the install list. Keep all existing modules. Do NOT add `example` or `merged` (those are not real modules).
  </action>
  <verify>
Count modules in install list — expect 36 (19 existing + 17 new).
Cross-reference against `ls modules/` minus example and merged — all should match.
  </verify>
  <done>
All 36 active modules are listed in deploy.yml install list, alphabetically ordered.
  </done>
</task>

<task type="manual">
  <name>Task 2: Secret scan</name>
  <files>
    (no files modified — scan only)
  </files>
  <action>
Scan all tracked and staged files for potential secrets:

**Step 1: Pattern scan for common secret formats**
```bash
grep -rn --include='*.yml' --include='*.yaml' --include='*.sh' --include='*.zsh' --include='*.conf' --include='*.cfg' --include='*.json' \
  -iE '(api[_-]?key|secret|token|password|credential|private[_-]?key|aws_access|ssh-rsa|BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE)' \
  modules/ playbooks/ \
  | grep -v 'config.yml:.*#' \
  | grep -v '\.gitignore'
```

**Step 2: Check for .env files or private keys**
```bash
find modules/ -name '.env*' -o -name '*.pem' -o -name '*.key' -o -name 'id_rsa*' -o -name 'id_ed25519*'
```

**Step 3: Check git staged files for secrets**
```bash
git diff --cached --diff-filter=A -- '*.yml' '*.sh' '*.json' | grep -iE '(key|secret|token|password)'
```

Must find zero real secrets. False positives (comments, placeholders, config keys) are OK — flag and explain.
  </action>
  <verify>
No real secrets found in any file destined for commit. Any matches are documented as false positives with explanation.
  </verify>
  <done>
Secret scan clean. Zero secrets in tracked files. Any false positives documented.
  </done>
</task>

<task type="manual">
  <name>Task 3: Corporate artifact scan</name>
  <files>
    (no files modified — scan only)
  </files>
  <action>
Scan all tracked files for corporate artifacts using the project's filter patterns.

```bash
grep -rn -iE '(expedia|expediagroup|ewegian|hotels\.com|vrbo|zscaler|jamf|corporate.vpn|eg-|egctl)' \
  modules/ playbooks/
```

Also check for corporate tool packages that should have been excluded:
```bash
grep -rn -iE '(aws-sam-cli|awscli|azure-cli|cfn-lint|egctl|helm|teleport|vault|saml2aws|terraform-docs|mongocli|mongosh|android-commandlinetools|android-ndk|android-platform-tools|expo-orbit)' \
  modules/*/config.yml
```

Must return empty — zero corporate artifacts.
  </action>
  <verify>
Zero matches for corporate patterns. Zero excluded corporate packages in any module config.
  </verify>
  <done>
Corporate artifact scan clean. No Expedia/corporate patterns found in any tracked file.
  </done>
</task>

<task type="manual">
  <name>Task 4: Ansible dry-run (--check)</name>
  <files>
    (no files modified — dry run only)
  </files>
  <action>
Run ansible in check mode to validate the playbook without making changes.

```bash
cd /Users/ianderson/src/dotfiles
ansible-playbook playbooks/deploy.yml -i playbooks/inventory --check --diff 2>&1
```

Review the output for:
1. **Errors** — any task failures indicate config problems to fix before real deploy
2. **Changed tasks** — expected changes (new packages to install, new symlinks to create)
3. **Unexpected changes** — anything that would modify files you didn't expect

If the dry run fails, diagnose and fix before proceeding.
  </action>
  <verify>
Dry run completes without errors. All "changed" items are expected (new package installs, new stow symlinks). No unexpected removals or modifications.
  </verify>
  <done>
Dry run passes. Expected changes reviewed and approved. Ready for real deploy.
  </done>
</task>

<task type="manual">
  <name>Task 5: Real deploy</name>
  <files>
    (no files modified — ansible applies system changes)
  </files>
  <action>
Run ansible for real to deploy all modules to this Mac Mini.

```bash
cd /Users/ianderson/src/dotfiles
ansible-playbook playbooks/deploy.yml -i playbooks/inventory --diff 2>&1
```

This will:
- Install all Homebrew packages and casks declared in module configs
- Stow config files into home directory via GNU Stow
- Apply any module-specific tasks

Monitor the output for failures. If a specific package fails (e.g., already installed differently, cask quarantine), note it but continue.
  </action>
  <verify>
Run completes successfully. Check:
1. `git config user.signingkey` — SSH signing key configured
2. `which tmux` — new formula installed
3. `ls -la ~/.gitconfig` — stow symlink exists
4. `brew list --formula | grep ffmpeg` — new formula present
5. `brew list --cask | grep firefox` — new cask present
  </verify>
  <done>
Real deploy succeeds. All modules applied. Key configs verified functional.
  </done>
</task>

</tasks>

<verification>
1. deploy.yml lists all 36 active modules
2. Secret scan returns zero real secrets
3. Corporate scan returns zero matches
4. Dry run passes without errors
5. Real deploy succeeds
6. Key post-deploy verifications pass (git, shell, packages)
</verification>

<success_criteria>
- All modules deployed to Mac Mini via ansible
- Zero secrets in repo
- Zero corporate artifacts in repo
- Old laptop is confirmed wipeable (all personal config captured)
</success_criteria>

<output>
After completion, create `.planning/phases/07-validation-deploy/07-01-SUMMARY.md`
</output>
